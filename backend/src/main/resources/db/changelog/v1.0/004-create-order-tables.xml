<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Orders -->
    <changeSet id="004-001-create-orders" author="claude">
        <createTable tableName="orders">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_number" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="customer_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_order_customer" references="customers(id)"/>
            </column>
            <column name="project_id" type="UUID">
                <constraints foreignKeyName="fk_order_project" references="customer_projects(id)"/>
            </column>
            <column name="warehouse_id" type="UUID"/>
            <column name="status" type="VARCHAR(20)" defaultValue="DRAFT">
                <constraints nullable="false"/>
            </column>
            <column name="order_date" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="required_date" type="DATE"/>
            <column name="delivery_date" type="DATE"/>
            <!-- Financial -->
            <column name="subtotal" type="DECIMAL(19,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="tax_amount" type="DECIMAL(19,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="discount_amount" type="DECIMAL(19,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="total_amount" type="DECIMAL(19,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <!-- Payment -->
            <column name="payment_method" type="VARCHAR(50)"/>
            <column name="payment_status" type="VARCHAR(20)" defaultValue="UNPAID">
                <constraints nullable="false"/>
            </column>
            <column name="paid_amount" type="DECIMAL(19,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <!-- Delivery -->
            <column name="delivery_address" type="VARCHAR(500)"/>
            <column name="delivery_city" type="VARCHAR(100)"/>
            <column name="delivery_postal_code" type="VARCHAR(20)"/>
            <column name="delivery_notes" type="TEXT"/>
            <!-- Users -->
            <column name="sales_person_id" type="UUID"/>
            <column name="created_by_id" type="UUID"/>
            <column name="notes" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Critical indexes for FAST order search -->
        <createIndex tableName="orders" indexName="idx_order_number">
            <column name="order_number"/>
        </createIndex>
        <createIndex tableName="orders" indexName="idx_order_customer">
            <column name="customer_id"/>
        </createIndex>
        <createIndex tableName="orders" indexName="idx_order_project">
            <column name="project_id"/>
        </createIndex>
        <createIndex tableName="orders" indexName="idx_order_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="orders" indexName="idx_order_date">
            <column name="order_date"/>
        </createIndex>
        <createIndex tableName="orders" indexName="idx_order_payment_status">
            <column name="payment_status"/>
        </createIndex>
        <!-- Composite indexes for common queries - PERFORMANCE OPTIMIZATION -->
        <createIndex tableName="orders" indexName="idx_order_customer_status">
            <column name="customer_id"/>
            <column name="status"/>
        </createIndex>
        <createIndex tableName="orders" indexName="idx_order_customer_date">
            <column name="customer_id"/>
            <column name="order_date"/>
        </createIndex>
    </changeSet>

    <!-- Order Lines -->
    <changeSet id="004-002-create-order-lines" author="claude">
        <createTable tableName="order_lines">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_order_line_order" references="orders(id)" deleteCascade="true"/>
            </column>
            <column name="line_number" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="product_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_order_line_product" references="products(id)"/>
            </column>
            <column name="product_code" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="product_name" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <!-- Quantity -->
            <column name="quantity" type="DECIMAL(19,3)">
                <constraints nullable="false"/>
            </column>
            <column name="unit_of_measure" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <!-- Cable specific -->
            <column name="is_cable" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="roll_id" type="UUID"/>
            <column name="cut_length" type="DECIMAL(19,3)"/>
            <!-- Pricing -->
            <column name="unit_price" type="DECIMAL(19,2)">
                <constraints nullable="false"/>
            </column>
            <column name="discount_percentage" type="DECIMAL(5,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="discount_amount" type="DECIMAL(19,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="tax_rate" type="DECIMAL(5,2)">
                <constraints nullable="false"/>
            </column>
            <column name="tax_amount" type="DECIMAL(19,2)">
                <constraints nullable="false"/>
            </column>
            <column name="line_total" type="DECIMAL(19,2)">
                <constraints nullable="false"/>
            </column>
            <!-- Status tracking -->
            <column name="quantity_picked" type="DECIMAL(19,3)" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="quantity_shipped" type="DECIMAL(19,3)" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="notes" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="order_lines" indexName="idx_order_line_order">
            <column name="order_id"/>
        </createIndex>
        <createIndex tableName="order_lines" indexName="idx_order_line_product">
            <column name="product_id"/>
        </createIndex>
        <createIndex tableName="order_lines" indexName="idx_order_line_number">
            <column name="order_id"/>
            <column name="line_number"/>
        </createIndex>
        <!-- Unique constraint for order + line number -->
        <addUniqueConstraint tableName="order_lines"
                           columnNames="order_id, line_number"
                           constraintName="uq_order_line_number"/>
    </changeSet>

    <!-- Seed Data: Sample Orders -->
    <changeSet id="004-003-seed-sample-orders" author="claude">
        <!-- Completed order for business customer -->
        <insert tableName="orders">
            <column name="id" value="11111111-1111-1111-1111-111111111111"/>
            <column name="order_number" value="ORD-20251028-0001"/>
            <column name="customer_id" valueComputed="(SELECT id FROM customers WHERE code = 'B001' LIMIT 1)"/>
            <column name="project_id" valueComputed="(SELECT id FROM customer_projects WHERE code = 'PROJ-2025-001' LIMIT 1)"/>
            <column name="status" value="COMPLETED"/>
            <column name="order_date" value="2025-10-28 10:30:00"/>
            <column name="delivery_date" value="2025-10-29"/>
            <column name="subtotal" value="250.00"/>
            <column name="tax_amount" value="52.50"/>
            <column name="total_amount" value="302.50"/>
            <column name="payment_method" value="BANK_TRANSFER"/>
            <column name="payment_status" value="PAID"/>
            <column name="paid_amount" value="302.50"/>
        </insert>

        <!-- Order lines for the completed order -->
        <insert tableName="order_lines">
            <column name="id" valueComputed="gen_random_uuid()"/>
            <column name="order_id" value="11111111-1111-1111-1111-111111111111"/>
            <column name="line_number" value="1"/>
            <column name="product_id" valueComputed="(SELECT id FROM products WHERE code = '0010006' LIMIT 1)"/>
            <column name="product_code" value="0010006"/>
            <column name="product_name" value="Kabelis YDYP 3x1.5"/>
            <column name="quantity" value="100"/>
            <column name="unit_of_measure" value="M"/>
            <column name="is_cable" valueBoolean="true"/>
            <column name="unit_price" value="1.25"/>
            <column name="tax_rate" value="21.00"/>
            <column name="tax_amount" value="26.25"/>
            <column name="line_total" value="151.25"/>
            <column name="quantity_picked" value="100"/>
            <column name="quantity_shipped" value="100"/>
        </insert>

        <insert tableName="order_lines">
            <column name="id" valueComputed="gen_random_uuid()"/>
            <column name="order_id" value="11111111-1111-1111-1111-111111111111"/>
            <column name="line_number" value="2"/>
            <column name="product_id" valueComputed="(SELECT id FROM products WHERE code = '0020001' LIMIT 1)"/>
            <column name="product_code" value="0020001"/>
            <column name="product_name" value="Automatinis jungiklis ABB S201 C16 1P"/>
            <column name="quantity" value="10"/>
            <column name="unit_of_measure" value="PCS"/>
            <column name="is_cable" valueBoolean="false"/>
            <column name="unit_price" value="8.50"/>
            <column name="tax_rate" value="21.00"/>
            <column name="tax_amount" value="17.85"/>
            <column name="line_total" value="102.85"/>
            <column name="quantity_picked" value="10"/>
            <column name="quantity_shipped" value="10"/>
        </insert>

        <!-- Draft order for contractor -->
        <insert tableName="orders">
            <column name="id" value="22222222-2222-2222-2222-222222222222"/>
            <column name="order_number" value="ORD-20251030-0001"/>
            <column name="customer_id" valueComputed="(SELECT id FROM customers WHERE code = 'C001' LIMIT 1)"/>
            <column name="status" value="DRAFT"/>
            <column name="order_date" value="2025-10-30 14:15:00"/>
            <column name="subtotal" value="0.00"/>
            <column name="tax_amount" value="0.00"/>
            <column name="total_amount" value="0.00"/>
            <column name="payment_method" value="CASH"/>
            <column name="payment_status" value="UNPAID"/>
        </insert>
    </changeSet>

</databaseChangeLog>
